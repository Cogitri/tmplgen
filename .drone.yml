---
kind: pipeline
name: default

clone:
  git:
    image: plugins/git
    tags: true
steps:
- name: submodules
  image: docker:git
  commands:
  - git submodule update --recursive --init
- name: test
  image: rust:latest
  commands:
  - export RUST_BACKTRACE=1
  - export GIT_AUTHOR_NAME="drone"
  - export GIT_AUTHOR_EMAIL="drone@exqa.de"
  - cargo build --verbose --all
  - cargo test --verbose --all
- name: generate-coverage
  image: xd009642/tarpaulin:develop-nightly
  privileged: true
  commands:
  - export GIT_AUTHOR_NAME="drone"
  - export GIT_AUTHOR_EMAIL="drone@exqa.de"
  - cargo tarpaulin --verbose --out Xml --timeout 300
- name: upload-coverage
  image: plugins/codecov
  settings:
    token:
      from_secret: codecov_token
      files:
      - cobertura.xml
      required: true
- name: package-release
  image: rust:latest
  commands:
  - cargo package
- name: publish-release
  image: plugins/github-release
  settings:
    api_key:
      from_secret: github_token
    files: target/package/*.crate
    checksum:
    - sha256
    when:
      event:
      - tag
- name: matrix-notification
  image: plugins/matrix
  settings:
    homeserver: https://matrix.org
    roomid: qOcHPTCOgAbkObQgRy:matrix.org
    username:
      from_secret: matrix_username
    password:
      from_secret: matrix_password
  when:
    status:
      - success
      - failure
      - changed
---
kind: signature
hmac: 972bed03daf6b0e0d44cdb4dee8a784c320bdd56c522549efd3aea7a60afbb7a

...
